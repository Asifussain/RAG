<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Real Estate Doc Intelligence</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body { background: #0f172a; }
    .glass {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(100, 116, 139, 0.25);
    }
    .drop-zone.dragover {
      border-color: #38bdf8;
      background: rgba(56, 189, 248, 0.08);
    }
    .score-bar {
      transition: width 0.6s ease;
    }
    .fade-in {
      animation: fadeIn 0.35s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* hide spinner arrows on number inputs */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; }
  </style>
</head>
<body class="text-gray-200 min-h-screen">

  <!-- ── Header ─────────────────────────────────────────────── -->
  <header class="border-b border-gray-800 px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-lg bg-sky-500 flex items-center justify-center font-bold text-white text-lg">R</div>
      <div>
        <h1 class="text-lg font-semibold text-white leading-tight">Real Estate Doc Intelligence</h1>
        <p class="text-xs text-gray-400">Upload PDFs. Ask questions. Get answers.</p>
      </div>
    </div>
    <div id="health-badge" class="text-xs px-3 py-1 rounded-full bg-gray-800 text-gray-400">
      checking...
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8 space-y-8">

    <!-- ── Upload Section ───────────────────────────────────── -->
    <section class="glass rounded-xl p-6">
      <h2 class="text-sm font-semibold text-gray-300 uppercase tracking-wider mb-4">Upload PDF</h2>

      <div id="drop-zone"
           class="drop-zone border-2 border-dashed border-gray-600 rounded-lg p-10 text-center cursor-pointer hover:border-gray-400 transition">
        <svg class="mx-auto mb-3 w-10 h-10 text-gray-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 16V4m0 0l-4 4m4-4l4 4M4 20h16" />
        </svg>
        <p class="text-gray-400 text-sm">Drag & drop a PDF here, or <span class="text-sky-400 underline">browse</span></p>
        <input type="file" id="file-input" accept=".pdf" class="hidden" />
      </div>

      <!-- Upload progress / result -->
      <div id="upload-status" class="mt-4 hidden fade-in"></div>
    </section>

    <!-- ── Indexed PDFs ─────────────────────────────────────── -->
    <section id="pdf-list-section" class="glass rounded-xl p-6 hidden">
      <h2 class="text-sm font-semibold text-gray-300 uppercase tracking-wider mb-3">Indexed Documents</h2>
      <div id="pdf-list" class="flex flex-wrap gap-2"></div>
      <p id="chunk-count" class="text-xs text-gray-500 mt-3"></p>
    </section>

    <!-- ── Query Section ────────────────────────────────────── -->
    <section class="glass rounded-xl p-6">
      <h2 class="text-sm font-semibold text-gray-300 uppercase tracking-wider mb-4">Ask a Question</h2>

      <form id="query-form" class="flex gap-3">
        <input id="query-input" type="text" placeholder="e.g. What amenities are available?"
               class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-sky-500 transition" />
        <div class="flex items-center gap-2">
          <label class="text-xs text-gray-500">Top-K</label>
          <input id="topk-input" type="number" value="3" min="1" max="10"
                 class="w-14 bg-gray-800 border border-gray-700 rounded-lg px-2 py-2.5 text-sm text-white text-center focus:outline-none focus:border-sky-500" />
        </div>
        <button type="submit"
                class="bg-sky-600 hover:bg-sky-500 text-white font-medium text-sm px-5 py-2.5 rounded-lg transition flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 103.5 3.5a7.5 7.5 0 0013.15 13.15z" />
          </svg>
          Search
        </button>
      </form>

      <!-- Results -->
      <div id="results-area" class="mt-6 space-y-4 hidden"></div>
    </section>

  </main>

  <!-- ── Footer ─────────────────────────────────────────────── -->
  <footer class="text-center text-xs text-gray-600 py-6">
    Built with FastAPI + FAISS + Sentence Transformers
  </footer>

<script>
const API = '';  // same origin

// ── Helpers ──────────────────────────────────────────────────
function $(sel) { return document.querySelector(sel); }
function show(el) { el.classList.remove('hidden'); }
function hide(el) { el.classList.add('hidden'); }

// ── Health Check ─────────────────────────────────────────────
async function checkHealth() {
  try {
    const r = await fetch(`${API}/health`);
    const d = await r.json();
    const badge = $('#health-badge');
    if (d.status === 'healthy') {
      badge.textContent = `Healthy \u2022 ${d.index_size} vectors`;
      badge.className = 'text-xs px-3 py-1 rounded-full bg-green-900 text-green-300';
    } else {
      badge.textContent = 'Unhealthy';
      badge.className = 'text-xs px-3 py-1 rounded-full bg-red-900 text-red-300';
    }
  } catch {
    const badge = $('#health-badge');
    badge.textContent = 'Offline';
    badge.className = 'text-xs px-3 py-1 rounded-full bg-red-900 text-red-300';
  }
}

// ── Load PDF list ────────────────────────────────────────────
async function loadPDFs() {
  try {
    const r = await fetch(`${API}/pdfs`);
    const d = await r.json();
    const list = $('#pdf-list');
    const section = $('#pdf-list-section');

    if (d.pdfs.length === 0) { hide(section); return; }

    show(section);
    list.innerHTML = d.pdfs.map(name =>
      `<span class="inline-flex items-center gap-1.5 bg-gray-800 text-gray-300 text-xs px-3 py-1.5 rounded-full">
        <svg class="w-3.5 h-3.5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V8l-6-6H4zm7 1.5L16.5 9H13a2 2 0 01-2-2V3.5z"/></svg>
        ${name}
      </span>`
    ).join('');
    $('#chunk-count').textContent = `${d.total_chunks} total chunks indexed`;
  } catch {}
}

// ── Upload ───────────────────────────────────────────────────
const dropZone = $('#drop-zone');
const fileInput = $('#file-input');
const uploadStatus = $('#upload-status');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  if (e.dataTransfer.files.length) uploadFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', () => {
  if (fileInput.files.length) uploadFile(fileInput.files[0]);
});

async function uploadFile(file) {
  if (!file.name.toLowerCase().endsWith('.pdf')) {
    showUploadStatus('Only PDF files are accepted.', 'error');
    return;
  }

  showUploadStatus(`Uploading <strong>${file.name}</strong> ...`, 'loading');

  const form = new FormData();
  form.append('file', file);

  try {
    const r = await fetch(`${API}/upload`, { method: 'POST', body: form });
    const d = await r.json();

    if (!r.ok) {
      showUploadStatus(d.detail || 'Upload failed.', 'error');
      return;
    }

    showUploadStatus(
      `<strong>${d.pdf_name}</strong> processed \u2014 ${d.chunks_created} chunks in ${(d.processing_time_ms / 1000).toFixed(1)}s`,
      'success'
    );
    checkHealth();
    loadPDFs();
  } catch (err) {
    showUploadStatus('Network error: ' + err.message, 'error');
  }

  fileInput.value = '';
}

function showUploadStatus(html, type) {
  show(uploadStatus);
  const colors = {
    loading: 'bg-sky-900/50 border-sky-700 text-sky-300',
    success: 'bg-green-900/50 border-green-700 text-green-300',
    error:   'bg-red-900/50 border-red-700 text-red-300',
  };
  uploadStatus.className = `mt-4 fade-in text-sm px-4 py-3 rounded-lg border ${colors[type]}`;
  uploadStatus.innerHTML = html;
}

// ── Query ────────────────────────────────────────────────────
$('#query-form').addEventListener('submit', async e => {
  e.preventDefault();
  const query = $('#query-input').value.trim();
  const topK = parseInt($('#topk-input').value) || 3;
  if (!query) return;

  const area = $('#results-area');
  show(area);
  area.innerHTML = '<p class="text-gray-400 text-sm">Searching...</p>';

  try {
    const r = await fetch(`${API}/query`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query, top_k: topK }),
    });
    const d = await r.json();

    if (!r.ok) {
      area.innerHTML = `<p class="text-red-400 text-sm">${d.detail || 'Query failed.'}</p>`;
      return;
    }

    if (d.results.length === 0) {
      area.innerHTML = '<p class="text-gray-400 text-sm">No results found.</p>';
      return;
    }

    area.innerHTML = `
      <div class="flex items-center justify-between text-xs text-gray-500 mb-2">
        <span>${d.total_results} result${d.total_results > 1 ? 's' : ''}</span>
        <span>${d.latency_ms.toFixed(0)} ms</span>
      </div>
      ${d.results.map((r, i) => renderResult(r, i)).join('')}
    `;
  } catch (err) {
    area.innerHTML = `<p class="text-red-400 text-sm">Network error: ${err.message}</p>`;
  }
});

function renderResult(r, idx) {
  const pct = Math.round(r.similarity_score * 100);
  const barColor = pct >= 70 ? 'bg-green-500' : pct >= 40 ? 'bg-yellow-500' : 'bg-red-500';
  return `
    <div class="fade-in bg-gray-800/60 border border-gray-700 rounded-lg p-4">
      <div class="flex items-start justify-between mb-2">
        <div class="flex items-center gap-2">
          <span class="text-xs font-mono bg-gray-700 text-gray-300 px-2 py-0.5 rounded">#${idx + 1}</span>
          <span class="text-xs text-gray-400">${r.pdf_name}</span>
          <span class="text-xs text-gray-500">p.${r.page_number}</span>
        </div>
        <span class="text-xs font-semibold ${pct >= 70 ? 'text-green-400' : pct >= 40 ? 'text-yellow-400' : 'text-red-400'}">${pct}%</span>
      </div>
      <div class="w-full bg-gray-700 rounded-full h-1 mb-3">
        <div class="score-bar ${barColor} h-1 rounded-full" style="width: ${pct}%"></div>
      </div>
      <p class="text-sm text-gray-300 leading-relaxed">${escapeHtml(r.text)}</p>
    </div>`;
}

function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

// ── Init ─────────────────────────────────────────────────────
checkHealth();
loadPDFs();
</script>
</body>
</html>
